<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</title>
<style>
body { font-family: Arial; padding: 20px; background: #f5f5f5; direction: rtl; }
.container { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
button { padding: 12px; width: 100%; margin-top: 10px; border: none; background: #1976d2; color: white; border-radius: 8px; font-size: 18px; }
select, input { width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; }
#locationOutput { margin-top: 10px; font-weight: bold; }
</style>

<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h2>ğŸ“Œ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h2>

<div class="container">
  <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
  <input type="text" id="employeeName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" />

  <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
  <select id="checkType">
    <option value="Check-in">Ø­Ø¶ÙˆØ±</option>
    <option value="Check-out">Ø§Ù†ØµØ±Ø§Ù</option>
  </select>
</div>

<div class="container">
  <h3>Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h3>
  <div id="reader" style="width: 100%;"></div>
  <p id="scanResult"></p>
  <p id="locationOutput"></p>
</div>

<script>
// ------------------------- QR Scanner -------------------------
function onScanSuccess(decodedText) {
  document.getElementById("scanResult").innerText = "ØªÙ… Ø§Ù„Ù…Ø³Ø­: " + decodedText;
  processAttendance(decodedText);
}

var html5QrCode = new Html5Qrcode("reader");
html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);

// ------------------------- MAIN FUNCTION -------------------------
function processAttendance(siteNameFromQR) {
  let employeeName = document.getElementById("employeeName").value.trim();
  let checkType = document.getElementById("checkType").value;

  if (!employeeName) { alert("âš  ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…"); return; }

  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        document.getElementById("locationOutput").innerText = "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: " + pos.coords.latitude + ", " + pos.coords.longitude;
        sendAttendance(employeeName, siteNameFromQR, checkType, pos.coords.latitude, pos.coords.longitude);
      },
      err => {
        alert("âš  ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.");
        console.error("Geolocation Error:", err);
      }
    );
  } else {
    alert("âš  Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
  }
}

// ------------------------- SEND ATTENDANCE -------------------------
function sendAttendance(employeeName, siteName, checkType, userLat, userLon) {
  fetch("https://script.google.com/macros/s/AKfycbwPdTyucCIGjAv5eRw_EDtD4WQg3Tmg03eQe_RA71FBK9HadkJbGyE1gAkQig84pmpfxw/exec", {
    method: "POST",
    body: JSON.stringify({
      employeeName: employeeName,
      siteName: siteName,
      checkType: checkType,
      timestamp: new Date().toLocaleString("sv-SE"),
      latitude: userLat,
      longitude: userLon
    })
  })
  .then(res => res.json())
  .then(res => {
    if (res.result === "success") {
      alert(
        "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­\n" +
        "Ø§Ù„Ù…Ø³Ø§ÙØ©: " + Math.round(res.distance) + " Ù…ØªØ±\n" +
        "Ø§Ù„Ø­Ø§Ù„Ø©: " + res.status
      );
    } else {
      alert("Ø®Ø·Ø£: " + res.message);
    }
  })
  .catch(err => {
    console.error(err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
  });
}
</script>

</body>
</html>
