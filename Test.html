<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ (ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆÙ…Ø­Ù„ÙŠ)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
  body {
    font-family: 'Cairo', sans-serif;
    background: #f3f6fb;
  }
  .card {
    background: white;
    border-radius: 18px;
    padding: 28px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid #e6e9ef;
  }
  .input-box {
    border: 1px solid #d9dce3;
    border-radius: 10px;
    padding: 10px 14px;
    transition: 0.2s;
  }
  .input-box:focus {
    border-color: #3b82f6; /* Blue-500 */
    outline: none;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.25);
  }
  #reader {
    min-height: 240px;
    border: 2px dashed #a5b4fc; /* Lavender */
    border-radius: 14px;
    background: #eef2ff; /* Very Light Lavender */
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6366f1; /* Indigo-500 */
    font-weight: 600;
  }
  .result-box {
    border-radius: 12px;
    padding: 12px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 15px;
  }
</style>
<script src="https://unpkg.com/html5-qrcode"></script>

</head>
<body class="p-5 md:p-10">

<div class="max-w-xl mx-auto">

  <h2 class="text-3xl font-bold text-center text-gray-800 mb-8 select-none">
    <span class="text-indigo-500 ml-2">ğŸ•’</span>
    Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)
    <div class="w-32 mx-auto mt-3 border-b-2 border-indigo-300"></div>
  </h2>
  
  <!-- Login Form (Uses LocalStorage) -->
  <div id="loginScreen" class="card" style="display: none;">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…Ø­Ù„ÙŠ)</h3>
      <div class="mb-4">
          <label for="loginUsername" class="font-semibold text-gray-700 mb-2 block">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
          <input type="text" id="loginUsername" class="w-full input-box" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù‡Ù†Ø§" required />
      </div>
      <div class="mb-6">
          <label for="loginPassword" class="font-semibold text-gray-700 mb-2 block">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø«Ø§Ø¨ØªØ© (12345):</label>
          <input type="password" id="loginPassword" class="w-full input-box" placeholder="12345" required />
      </div>
      <button id="loginButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
          ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„
      </button>
      <div id="loginError" class="mt-4 text-red-600 text-sm font-medium" style="display: none;"></div>
  </div>

  <!-- Attendance Form (Main App) -->
  <div id="attendanceApp" style="display: none;">
      <div class="card mb-7">
          <label class="font-semibold text-gray-700 mb-2 block">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (ØªÙ… Ø­ÙØ¸Ù‡):</label>
          <!-- Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
          <input id="employeeName" class="w-full input-box bg-gray-100 cursor-not-allowed" readonly />
          
          <p class="text-sm text-gray-500 mt-4">
              <span class="font-semibold">Ù…Ù„Ø§Ø­Ø¸Ø©:</span> Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø£Ùˆ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ….
          </p>
      </div>

      <div class="card">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 select-none">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h3>

          <div id="reader" class="mb-5">Ø¬Ø§Ø±Ù ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§â€¦</div>

          <div class="space-y-3 text-sm">

              <div id="scanResult" class="result-box bg-blue-50 text-blue-700 border-r-4 border-blue-500">
                  <span>ğŸ”—</span> <span>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø­ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</span>
              </div>

              <div id="locationOutput" class="result-box bg-green-50 text-green-700 border-r-4 border-green-500">
                  <span>ğŸ“</span> <span>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</span>
              </div>

              <div id="serverOutput" class="result-box bg-gray-50 text-gray-700 border-r-4 border-gray-500 whitespace-pre-wrap">
                  <span>â„¹ï¸</span> <span>Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ù‚Ù… Ø¨Ø§Ù„Ù…Ø³Ø­ Ù„Ù„Ø¨Ø¯Ø¡)</span>
              </div>
          </div>
          
          <button id="logoutButton" class="mt-6 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
              ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
          </button>
      </div>
  </div>

</div>

<script>
// ==========================================================
// 1. LOCAL STORAGE & AUTH LOGIC (No Firebase)
// ==========================================================
const EMPLOYEE_NAME_KEY = 'attendance_employee_name';
const CORRECT_PASSWORD = "12345"; // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø«Ø§Ø¨ØªØ©
let currentEmployeeName = "";
let html5QrCode;

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function showLoginError(message) {
    const errorElement = document.getElementById('loginError');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function showView(viewName) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('attendanceApp').style.display = 'none';

    if (viewName === 'form') {
        document.getElementById('attendanceApp').style.display = 'block';
    } else if (viewName === 'login') {
        document.getElementById('loginScreen').style.display = 'block';
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage
function handleLogin() {
    const usernameInput = document.getElementById('loginUsername');
    const passwordInput = document.getElementById('loginPassword');
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    
    document.getElementById('loginError').style.display = 'none';

    if (!username || !password) {
        showLoginError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
        return;
    }

    if (password === CORRECT_PASSWORD) {
        // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        localStorage.setItem(EMPLOYEE_NAME_KEY, username);
        currentEmployeeName = username;
        document.getElementById('employeeName').value = currentEmployeeName;
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù…Ø§Ø³Ø­
        showView('form');
        initScanner();
    } else {
        showLoginError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ)
function handleLogout() {
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    if (html5QrCode && html5QrCode.isScanning()) {
        html5QrCode.stop().catch(e => console.error("Error stopping scanner on logout:", e));
    }
    
    localStorage.removeItem(EMPLOYEE_NAME_KEY);
    currentEmployeeName = "";
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    showView('login');
}

document.addEventListener('DOMContentLoaded', () => {
    // 1. ØªÙ‡ÙŠØ¦Ø© Html5Qrcode
    html5QrCode = new Html5Qrcode("reader");

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    currentEmployeeName = localStorage.getItem(EMPLOYEE_NAME_KEY);

    if (currentEmployeeName) {
        document.getElementById('employeeName').value = currentEmployeeName;
        showView('form');
        initScanner();
    } else {
        showView('login');
    }
    
    // 3. Ø±Ø¨Ø· Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    document.getElementById('loginButton').addEventListener('click', handleLogin);
    document.getElementById('logoutButton').addEventListener('click', handleLogout);
});


// ==========================================================
// 2. ATTENDANCE APP LOGIC (Updated to remove checkType)
// ==========================================================

let isProcessing = false;

// ===== Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =====
function showMessage(type, message) {
    const outputElement = document.getElementById("serverOutput");
    let baseClass = "result-box border-r-4 whitespace-pre-wrap";
    let icon = '';

    if (type === 'success') {
        outputElement.className = `${baseClass} bg-green-100 text-green-800 border-green-600`;
        icon = 'âœ…';
    } else if (type === 'warning') {
        outputElement.className = `${baseClass} bg-yellow-100 text-yellow-800 border-yellow-600`;
        icon = 'âš ï¸';
    } else {
        outputElement.className = `${baseClass} bg-red-100 text-red-800 border-red-600`;
        icon = 'âŒ';
    }

    outputElement.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
}

// ===== QR Scanner and Restart Logic =====

function onScanSuccess(decodedText) {
    if (isProcessing) return;
    isProcessing = true;

    document.getElementById("scanResult").innerHTML =
        `<span>ğŸ”</span> <span>ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­: ${decodedText} (Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...)</span>`;

    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ù‚Ø¨Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø±
    if (html5QrCode && html5QrCode.isScanning()) {
        html5QrCode.stop().then(() => {
            processAttendance(decodedText);
        }).catch(err => {
            console.error("Failed to stop scanner after scan:", err);
            processAttendance(decodedText); // ØªØ§Ø¨Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
        });
    } else {
        processAttendance(decodedText);
    }
}

function restartScanner() {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ù‹Ø§
    if (!currentEmployeeName || !html5QrCode) return; 

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø§Ø³Ø­
    const readerElement = document.getElementById("reader");
    readerElement.textContent = ''; 
    
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø§Ø³Ø­ Ù„ÙŠØ³ ÙÙŠ Ø­Ø§Ù„Ø© Ù…Ø³Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
    if (!html5QrCode.isScanning()) {
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess)
        .catch(err => {
            console.error("Scanner failed to start:", err);
            readerElement.innerHTML = `
                <div class="text-center p-4">
                    <span class="text-2xl">âš ï¸</span>
                    <p class="mt-2">ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.</p>
                </div>`;
            showMessage('error','âš ï¸ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.');
            isProcessing = false;
        });
    }
}

function initScanner() {
    // Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø±Ø¦ÙŠØ§Ù‹ ÙˆØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (document.getElementById('attendanceApp').style.display === 'block' && currentEmployeeName) {
         restartScanner();
    }
}


// ===== GPS ONLY =====
function getLocationWithFallback(callback) {
    document.getElementById("locationOutput").innerHTML = `<span>â³</span> <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>`;

    if (!("geolocation" in navigator)) {
        callback({
            error: true,
            message: "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS)"
        });
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos => {
            callback({
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
                source: "GPS"
            });
        },
        err => {
            callback({
                error: true,
                message: "ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± GPS. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆÙ…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†."
            });
        },
        { timeout: 10000, enableHighAccuracy: true }
    );
}

// ===== Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =====
function processAttendance(siteNameFromQR) {
    let employeeName = currentEmployeeName;
    // ØªÙ… Ø¥Ø²Ø§Ù„Ø© checkType Ù…Ù† Ù‡Ù†Ø§

    if (!employeeName) {
        showMessage('error', 'âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.');
        isProcessing = false;
        restartScanner();
        return;
    }

    showMessage('warning', '... Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹');

    getLocationWithFallback(function(loc) {

        if (loc.error) {
            showMessage('error', loc.message);
            isProcessing = false;
            restartScanner();
            return;
        }

        document.getElementById("locationOutput").innerHTML =
            `<span>ğŸ“</span> <span>Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${loc.latitude.toFixed(6)}, ${loc.longitude.toFixed(6)} (GPS)</span>`;

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† checkType
        sendAttendance(employeeName, siteNameFromQR, loc.latitude, loc.longitude);
    });
}

// ===== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
function sendAttendance(employeeName, siteName, userLat, userLon) {
    // âš ï¸ Ù‡Ø°Ø§ Ù‡Ùˆ Ø±Ø§Ø¨Ø· Google Apps Script Ø§Ù„Ø°ÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkkWDJ2o4CYzU4kBMhC40tWiixdwb-f5tquOQwj8hQoOKIDt0i-y8Mj9Ez0BecQSx_Nw/exec"; 

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø°ÙŠ ÙŠÙ…ÙƒÙ† Ù„Ù€ Apps Script ÙÙ‡Ù…Ù‡ ÙˆØªÙ‚Ø³ÙŠÙ…Ù‡
    const now = new Date();
    const timestampISO = now.toISOString();

    fetch(SCRIPT_URL, {
        method: "POST",
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            employeeName,
            siteName,
            timestamp: timestampISO, // Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø³ÙŠÙ‚ ISO Ù„ÙŠØªÙ… ØªÙ‚Ø³ÙŠÙ…Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
            latitude: userLat,
            longitude: userLon
        })
    })
    .then(res => res.json())
    .then(resObj => {
        isProcessing = false;
        restartScanner();

        if (!resObj || resObj.result === undefined) {
            showMessage('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±. Ø§Ù„Ø±Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­.');
            return;
        }

        if (resObj.result === "success") {
            let action = resObj.action === "Check-in" ? "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø¨Ù†Ø¬Ø§Ø­";
            let hours = resObj.hours ? ` | Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ§Ù…: ${resObj.hours}` : '';
            let distanceMsg = resObj.distance !== undefined ? ` | Ø§Ù„Ù…Ø³Ø§ÙØ©: ${Math.round(resObj.distance)} Ù…ØªØ±` : '';
            
            showMessage('success', `${action}${distanceMsg}${hours}`);
        } else {
            // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Ù…Ø«Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ)
            let errorMessage = typeof resObj.message === "string" ? resObj.message : "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            showMessage('error', `ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${errorMessage}`);
        }
    })
    .catch(err => {
        isProcessing = false;
        restartScanner();
        // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø§ØªØµØ§Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©
        showMessage('error', `Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„: ${err.message || String(err)}. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.`);
    });
}
</script>

</body>
</html>