<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ (ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆÙ…Ø­Ù„ÙŠ)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
body { font-family:'Cairo',sans-serif; background:#f3f6fb; }
.card{background:white;border-radius:18px;padding:28px;box-shadow:0 4px 20px rgba(0,0,0,.08);border:1px solid #e6e9ef;}
.input-box{border:1px solid #d9dce3;border-radius:10px;padding:10px 14px;}
#reader{min-height:240px;border:2px dashed #a5b4fc;border-radius:14px;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-weight:600;}
.result-box{border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:10px;font-size:15px;}
</style>
</head>

<body class="p-5 md:p-10">
<div class="max-w-xl mx-auto">

<h2 class="text-3xl font-bold text-center text-gray-800 mb-8">
ğŸ•’ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)
</h2>

<div id="loginScreen" class="card" style="display:none;">
  <h3 class="text-xl font-semibold mb-6">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
  <input id="loginUsername" class="w-full input-box mb-4" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" />
  <input id="loginPassword" class="w-full input-box mb-4" type="password" placeholder="12345" />
  <button id="loginButton" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Ø¯Ø®ÙˆÙ„</button>
  <div id="loginError" class="mt-3 text-red-600 text-sm" style="display:none;"></div>
</div>

<div id="attendanceApp" style="display:none;">
  <div class="card mb-7">
    <label class="font-semibold mb-2 block">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
    <input id="employeeName" class="w-full input-box bg-gray-100" readonly />
  </div>

  <div class="card">
    <h3 class="text-xl font-semibold mb-4">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h3>
    <div id="reader">Ø¬Ø§Ø±Ù ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>

    <div class="space-y-3 text-sm mt-4">
      <div id="scanResult" class="result-box bg-blue-50">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø­ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
      <div id="locationOutput" class="result-box bg-green-50">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
      <div id="serverOutput" class="result-box bg-gray-50">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
    </div>

    <button id="logoutButton" class="mt-6 w-full bg-red-500 text-white py-2 rounded-lg">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

</div>

<script>
const EMPLOYEE_NAME_KEY='attendance_employee_name';
const CORRECT_PASSWORD="12345";

let html5QrCode;
let currentEmployeeName="";
let isProcessing=false;

// ğŸ”Š ØµÙˆØª Ù†Ø¬Ø§Ø­
const successSound = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

function showView(v){
  loginScreen.style.display="none";
  attendanceApp.style.display="none";
  (v==="login"?loginScreen:attendanceApp).style.display="block";
}

function showLoginError(msg){
  loginError.textContent=msg;
  loginError.style.display="block";
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function handleLogin(){
  const u=loginUsername.value.trim();
  const p=loginPassword.value.trim();
  loginError.style.display="none";

  if(!u||!p) return showLoginError("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

  if(p===CORRECT_PASSWORD){
    localStorage.setItem(EMPLOYEE_NAME_KEY,u);
    currentEmployeeName=u;
    employeeName.value=u;
    showView("form");
    setTimeout(initScanner,500);
  }else showLoginError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
function handleLogout(){
  if(html5QrCode) html5QrCode.stop().catch(()=>{});
  localStorage.removeItem(EMPLOYEE_NAME_KEY);
  currentEmployeeName="";
  showView("login");
}

// Ø±Ø³Ø§Ù„Ø©
function showMessage(type,msg){
  let icon=type==="success"?"âœ…":type==="warning"?"âš ï¸":"âŒ";
  serverOutput.innerHTML=`${icon} ${msg}`;
}

// âœ… Ø§Ù„Ø³ÙƒØ§Ù†Ø±
function onScanSuccess(txt){
  if(isProcessing) return;
  isProcessing=true;
  successSound.play().catch(()=>{});
  scanResult.innerHTML=`âœ… ØªÙ… Ø§Ù„Ù…Ø³Ø­: ${txt}`;
  html5QrCode.stop().then(()=>processAttendance(txt)).catch(()=>processAttendance(txt));
}

function initScanner(){
  html5QrCode=new Html5Qrcode("reader");
  html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},onScanSuccess)
  .catch(()=>showMessage('error','ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'));
}

function restartScanner(){
  if(!currentEmployeeName||!html5QrCode) return;
  setTimeout(()=>initScanner(),1200);
}

// ğŸ“ GPS
function getLocation(cb){
  if(!navigator.geolocation) return cb({error:true,message:"Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…"});
  navigator.geolocation.getCurrentPosition(p=>{
    cb({lat:p.coords.latitude,lon:p.coords.longitude});
  },()=>cb({error:true,message:"ÙØ¹Ù‘Ù„ GPS"}));
}

// ğŸ”„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
function processAttendance(site){
  showMessage('warning','Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
  getLocation(loc=>{
    if(loc.error){
      showMessage('error',loc.message);
      isProcessing=false;
      restartScanner();
      return;
    }
    locationOutput.innerHTML=`ğŸ“ ${loc.lat}, ${loc.lon}`;
    sendAttendance(site,loc.lat,loc.lon);
  });
}

// ğŸ“¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function sendAttendance(site,lat,lon){
  fetch("https://script.google.com/macros/s/AKfycbyiiDTOSUf8Hx9scY_vKkoaoXBmpq52wBaWF7iSWApJBrdLTygOMkaGrp0WyyuYKlFl/exec",{
    method:"POST",
    body:JSON.stringify({
      employeeName:currentEmployeeName,
      siteName:site,
      timestamp:new Date().toISOString(),
      latitude:lat,longitude:lon
    })
  })
  .then(r=>r.json()).then(r=>{
    isProcessing=false;
    restartScanner();
    if(r.result==="success"){
      showMessage('success',`ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ | Ø§Ù„Ù…Ø³Ø§ÙØ©: ${Math.round(r.distance)}Ù…`);
    }else showMessage('error',r.message||"ÙØ´Ù„");
  }).catch(()=>{
    isProcessing=false;
    restartScanner();
    showMessage('error','Ø®Ø·Ø£ Ø§ØªØµØ§Ù„');
  });
}

// bootstrap
document.addEventListener('DOMContentLoaded',()=>{
  currentEmployeeName=localStorage.getItem(EMPLOYEE_NAME_KEY);
  if(currentEmployeeName){
    employeeName.value=currentEmployeeName;
    showView("form");
    setTimeout(initScanner,500);
  }else showView("login");

  loginButton.onclick=handleLogin;
  logoutButton.onclick=handleLogout;
});
</script>
</body>
</html>
